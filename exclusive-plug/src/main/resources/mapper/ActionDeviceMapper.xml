<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qg.exclusiveplug.dao.ActionDeviceMapper">

    <insert id="addUserDeviceInfo" parameterType="userDeviceInfo">
        INSERT INTO user_device
        (user_id, device_index, user_privilege)
        VALUES
        (
          ${userId},
          ${deviceIndex},
          ${userPrivilege}
        )
    </insert>
    <insert id="addDeviceInfo" parameterType="deviceInfo">
        INSERT INTO device_info
        (device_index, device_work_power, device_standby_power, auto_close)
        VALUES
        (
          ${deviceIndex},
          ${deviceWorkPower},
          ${deviceStandbyPower},
          ${autoClose}
        )
    </insert>
    <update id="updateUserDeviceInfo" parameterType="UserDeviceInfo">
        UPDATE user_device
        SET user_privilege = ${userPrivilege}
        WHERE user_id = ${userId}
        AND device_index = ${deviceIndex}
    </update>
    <update id="updateDeviceInfo" parameterType="deviceInfo">
        UPDATE device_info SET
        device_index = ${deviceIndex}
        <if test="null != deviceWorkPower">
            , device_work_power = ${deviceWorkPower}
        </if>
        <if test="null != deviceStandbyPower">
            , device_standby_power = ${deviceStandbyPower}
        </if>
        <if test="null != autoClose">
            , auto_close = ${autoClose}
        </if>
        WHERE device_index = ${deviceIndex}
    </update>
    <delete id="delUserDeviceInfo">
        DELETE FROM user_device
        WHERE user_id = ${userId}
        AND device_index = ${deviceIndex}
    </delete>
    <delete id="delDeviceInfo">
        DELETE FROM device_info
        WHERE device_index = ${deviceIndex}
    </delete>
    <select id="queryUserDeviceInfo" resultType="UserDeviceInfo">
        SELECT user_id, device_index, user_privilege
        FROM user_device
        WHERE user_id = ${userId}
        AND device_index = ${deviceIndex}
    </select>
    <select id="queryDeviceUuidByUuid" resultType="DeviceUuid">
        SELECT device_index, device_privilege
        FROM device_uuid
        WHERE uuid = #{uuid}
    </select>
    <select id="queryDeviceInfo" resultType="com.qg.exclusiveplug.model.DeviceInfo">
        SELECT *
        FROM device_info
        WHERE device_index = ${deviceIndex}
    </select>
    <select id="listUserDeviceIndex" resultType="UserDeviceInfo">
        SELECT device_index, user_privilege
        FROM user_device
        WHERE user_id = ${userId}
    </select>
    <select id="queryDeviceLog" resultType="com.qg.exclusiveplug.model.DeviceLog">
        SELECT *
        FROM device_log
        WHERE device_index = ${deviceIndex}
    </select>
    <select id="listTiming" resultType="com.qg.exclusiveplug.model.Timing">
        SELECT *
        FROM timing
        WHERE user_id = ${userId}
    </select>
    <select id="getLastDeviceNameByindex" resultType="java.lang.String">
        SELECT name FROM ${table}
        WHERE index_num = ${index}
        ORDER BY date DESC
        LIMIT 1;
    </select>

    <update id="updateDevicePowerRange">
        UPDATE device_power dp SET
            min_power = ${minPower},
            max_power = ${maxPower},
            name = #{name},
        WHERE dp.index = ${index}
    </update>

    <insert id="insertDevicePowerRange">
        INSERT INTO device_power
        (name, min_power, max_power, device_power.index)
        VALUES
        (
          #{name},
          ${minPower},
          ${maxPower},
          ${index}
        )
    </insert>

    <delete id="delDevicePowerByIndex" >
        DELETE FROM device_power WHERE device_power.index = ${index};

    </delete>
    <delete id="delTiming">
        DELETE FROM timing
        WHERE id = ${id}
    </delete>
    <delete id="delPowerRangeExceptIndex">
        DELETE FROM device_power
        WHERE name = #{deviceName}
        AND device_power.index = 0;
    </delete>

    <!--<update id="updadeDevicePowerRangeByIndex" parameterType="com.qg.exclusiveplug.model.DevicePowerRange">
        UPDATE device_power dp SET
        min_power = ${minPower},
        max_power = ${maxPower},
        status = ${status},
        dp.index = 0,
    </update>-->

    <insert id="insertAllDevicePowerRange" parameterType="com.qg.exclusiveplug.model.DevicePowerRange">
        INSERT INTO device_power
        (name, min_power, max_power, min_pf, max_pf, status, device_power.index)
        VALUES
        <foreach collection="devicePowerRangeList" index="index" item="item" separator=",">
            (
            #{item.name},
            ${item.minPower},
            ${item.maxPower},
            ${item.minPf},
            ${item.maxPf},
            ${item.status},
            0
            )
        </foreach>
    </insert>
    <insert id="insertTiming" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO timing
        (timing.index, timing.key, timing.time, timing.user_id)
        VALUES
        (
            ${index},
            ${key},
            #{time},
            ${userId}
        )
    </insert>
    <insert id="addDeviceLog">
        INSERT INTO device_log
        (device_index, device_name, device_status, device_time, device_reason)
        VALUES
        (
            ${deviceIndex},
            #{deviceName},
            ${deviceStatus},
            #{deviceTime},
            #{deviceReason}
        )
    </insert>
</mapper>